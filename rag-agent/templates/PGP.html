<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGP-GT</title>
    <!-- MathJax for LaTeX rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\(', '\)']],
                displayMath: [['$$', '$$'], ['\[', '\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

        body {
            background: radial-gradient(circle at 85% 85%, rgba(0, 0, 0, 0.05), rgba(255, 255, 255, 1) 70% );
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #e5e7eb;
            padding: clamp(20px, 4vw, 40px);
            letter-spacing: -0.01em;
        }

        .container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            border: 7px solid #F6F5F0;
            background-color: #F6F5F0;
            border-radius: 24px;
            box-shadow: 
            10px 15px 15px rgba(128, 128, 128, 0.1),     /* outer shadow (gray) */
            -10px -10px 10px rgba(255, 255, 255, 1),     /* outer highlight (white) */
            inset 7px 7px 10px rgba(128, 128, 128, 0.1), /* inner shadow (gray) */
            inset -7px -7px 10px rgba(255, 255, 255, 1); /* inner highlight (white) */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
            z-index: 9;
        }

        /* Header Component */
        .header {
            background: #ed5d05;
            padding: clamp(16px, 3vw, 24px);
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 2px solid #000;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header .logo {
            width: clamp(50px, 6vw, 60px);
            height: auto;
            border-radius: 12px;
            object-fit: cover;
        }

        .header h1 {
            font-size: clamp(18px, 2.5vw, 24px);
            font-weight: 600;
            color: #161616;
            letter-spacing: -0.02em;
        }

        .toggle-container {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toggle-label {
            font-size: clamp(12px, 1.8vw, 14px);
            color: #e5e7eb;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 18px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4A4A4A;
            transition: 0.3s;
            border-radius: 18px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: #e5e7eb;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #ed5d05;
        }

        input:checked + .slider:before {
            transform: translateX(18px);
        }

        /* Chat Area Component */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: clamp(8px, 2vw, 16px);
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 1.5vw, 10px);
        }

        .welcome-message-area {
            display: flex;
            flex-direction: column; 
            align-items: center; 
            gap: 15px; 
            max-width: 80%; 
            margin: auto; 
        }

        .bot-icon {
            width: 100px; 
            height: auto;
            display: block; 
            margin-bottom: 10px; 
        }

        .welcome-text {
            font-size: clamp(1.5rem, 4vw, 2rem); 
            font-weight: bold;
            color: #7f7f7c97; 
            margin: 0; 
        }

        .question-text {
            font-size: clamp(1.2rem, 3.5vw, 1.6rem); 
            color: #7f7f7c97; 
            margin: 0; 
        }

        .chat-container::-webkit-scrollbar {
            width: 5px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #ed5d05;
            border-radius: 3px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            animation: slideIn 0.3s ease;
        }

        .user-message {
            justify-content: flex-end;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: clamp(12px, 2vw, 16px) clamp(14px, 2.5vw, 20px);
            border-radius: 16px;
            line-height: 1.5;
            font-size: clamp(14px, 1.8vw, 16px);
            position: relative;
            letter-spacing: -0.01em;
        }

        /* Table styles - exact copy from index2.html */
        .message-bubble table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1); /* Adjusted to match index2.html */
            border-radius: 8px;
            overflow: hidden;
        }

        .message-bubble th {
            background: #ed5d0587; /* Blue-like header background from index2.html */
            color: #000; /* Blue-like header text color from index2.html */
            font-weight: 600;
            padding: 12px;
            text-align: left;
            border: 1px solid #ed5d05; /* Blue-like border from index2.html */
            white-space: normal; /* Ensure wrapping for long content */
        }

        .message-bubble td {
            padding: 10px 12px;
            border: 1px solid #ed5d05; /* Blue-like border from index2.html */
            white-space: normal; /* Ensure wrapping for long content */
            vertical-align: top; /* Align cell content to top */
            color: #000; /* Keep the message bubble text color */
        }

        .message-bubble tr:nth-child(even) {
             background: rgba(235, 119, 37, 0.05); /* Alternating row background from index2.html */
        }

        .message-bubble tr:hover {
            background: rgba(37, 99, 235, 0.1); /* Hover effect background from index2.html */
        }

        /* Document header styles */
        .message-bubble h3 {
            color: #ed5d05;
            font-weight: 600;
            margin: 20px 0 10px 0;
            font-size: 1.1em;
        }

        /* Add styles for code blocks and inline code */
        .message-bubble pre {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-bubble code {
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
        }

        .message-bubble pre code {
            background: none;
            padding: 0;
        }

        .user-message .message-bubble {
            background: #ed5d05;
            color: #fff;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
        }

        .bot-message .message-bubble {
            background: #f9f9f9;
            color: #161616;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px #d4d4d4;
        }

        .timestamp {
            font-size: clamp(10px, 1.5vw, 12px);
            color: #a0aec0;
            margin-top: 3px;
            letter-spacing: -0.01em;
        }

        .avatar {
            width: clamp(32px, 4vw, 40px);
            height: clamp(32px, 4vw, 40px);
            border-radius: 50%;
            margin: 0 clamp(8px, 1.5vw, 12px);
            object-fit: cover;
            border: 2px solid #ed5d05;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
        }

        .bot-avatar {
            border-color: #4A4A4A;
            box-shadow: 0 2px 8px rgba(74, 74, 74, 0.2);
        }

        .error-message {
            color: #ed5d05;
            font-size: clamp(12px, 1.8vw, 14px);
            text-align: center;
            padding: 8px;
            animation: slideIn 0.3s ease;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .loader {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: clamp(6px, 1.5vw, 10px);
        }

        .loader::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 3px solid #ed5d05;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .typing-indicator {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: clamp(6px, 1.5vw, 10px);
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: #4A4A4A;
            border-radius: 50%;
            margin: 0 3px;
            animation: bounce 0.6s infinite alternate;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        .input-container {
            align-self: center;
            width: 95%;
            padding: clamp(12px, 2vw, 16px);
            border-top: 2px solid #ed5d05;
            display: flex;
            align-items: center;
            gap: 8px;
            position: sticky;
            bottom: 0;
            z-index: 10;
            flex-wrap: wrap;
            border-radius: 10px;
            -webkit-backdrop-filter: blur(50px);
            backdrop-filter: blur(50px);
            border: solid 4px #fff;
            background-image: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2) 33%, #fff 97%);
        }

        .input-textarea {
            flex: 1;
            background: transparent;
            border: none;
            border-radius: 50px;
            padding: clamp(10px, 2vw, 14px) clamp(12px, 2.5vw, 18px);
            color: #7f7f7c;
            font-size: clamp(14px, 1.8vw, 16px);
            resize: none;
            height: 50px;
            outline: none;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
            min-width: 200px;
            box-shadow: 
                inset 7px 7px 15px #cfcfcf,  /* gray */
                inset -5px -5px 10px rgba(255, 255, 255, 1);  /* white */
        }

        .input-textarea:focus {
            border-color: #4A4A4A;
            box-shadow: 0 0 0 3px rgba(74, 74, 74, 0.3);
        }

        .input-textarea:hover {
            border-color: #4A4A4A;
        }

        .send-button, .mic-button, .mute-button {
            background: #ed5d05;
            color: #fff;
            padding: 10px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: clamp(14px, 1.8vw, 16px);
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: -0.01em;
            touch-action: manipulation;
            width: 48px;
            height: 48px;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
        }

        .send-button {
            border-radius: 12px;
            width: auto;
            padding: 10px 20px;
            height: 48px;
            min-width: 44px;
        }

        .send-button:hover, .mic-button:hover, .mute-button:hover {
            background: #FF8B5E;
            box-shadow: 0 0 50px rgba(255, 107, 53, 2.5), 0 0 25px rgba(255, 107, 53, 1.8);
        }

        .send-button.processing {
            background: #4A4A4A;
        }

        .mic-button.recording {
            background: #FF8B5E;
            animation: glow 0.8s infinite alternate ease-in-out;
        }

        .mute-button.muted {
            background: #4A4A4A;
        }

        @keyframes glow {
            from { box-shadow: 0 0 10px rgba(255, 107, 53, 0.7); }
            to { box-shadow: 0 0 40px rgba(255, 107, 53, 2); }
        }

        .footer {
            text-align: center;
            padding: clamp(12px, 2vw, 16px);
            font-size: clamp(13px, 1.8vw, 15px);
            color: #a0aec0;
            letter-spacing: -0.01em;
        }

        .footer a {
            color: #ed5d05;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer a:hover {
            color: #FF8B5E;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-4px);
            }
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 8px;
                padding: 15px;
            }

            .header {
                padding: 10px;
            }

            .header .logo {
                width: 40px;
            }

            .header h1 {
                font-size: 18px;
            }

            .toggle-container {
                gap: 4px;
            }

            .toggle-label {
                font-size: 12px;
            }

            .toggle-switch {
                width: 30px;
                height: 15px;
            }

            .slider:before {
                height: 11px;
                width: 11px;
                bottom: 2px;
                left: 2px;
            }

            input:checked + .slider:before {
                transform: translateX(15px);
            }

            .chat-container {
                padding: 10px;
                gap: 8px;
            }

            .welcome-message-area {
                max-width: 95%;
            }

            .welcome-text {
                font-size: 1.2rem;
            }

            .question-text {
                font-size: 1rem;
            }

            .chat-container::-webkit-scrollbar {
                width: 3px;
            }

            .chat-container::-webkit-scrollbar-thumb {
                border-radius: 2px;
            }

            .message-bubble {
                padding: 10px 14px;
                border-radius: 12px;
                font-size: 14px;
            }

            .message-bubble table,
            .message-bubble th,
            .message-bubble td {
                font-size: 13px;
                padding: 8px;
            }

            .message-bubble h3 {
                font-size: 1em;
                margin: 15px 0 8px 0;
            }

            .avatar {
                width: 30px;
                height: 30px;
                margin: 0 6px;
            }

            .input-container {
                padding: 10px;
                gap: 6px;
                flex-wrap: nowrap;
            }

            .input-textarea {
                height: 40px;
                padding: 8px 12px;
                font-size: 14px;
                flex-grow: 1;
            }

            .send-button, .mic-button, .mute-button {
                padding: 8px;
                width: 40px;
                height: 40px;
                font-size: 14px;
            }

            .send-button {
                padding: 8px 16px;
                min-width: 40px;
                height: 40px;
            }

            .sheets-button {
                width: 40px;
                height: 40px;
                margin-left: 6px;
                border-radius: 10px;
            }

            .footer {
                padding: 10px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .container {
                border-radius: 0;
                padding: 10px;
            }

            .header {
                padding: 6px;
            }

            .header .logo {
                width: 35px;
            }

            .header h1 {
                font-size: 16px;
            }

            .toggle-switch {
                width: 28px;
                height: 14px;
            }

            .slider:before {
                height: 10px;
                width: 10px;
                bottom: 2px;
                left: 2px;
            }

            input:checked + .slider:before {
                transform: translateX(14px);
            }

            .chat-container {
                padding: 6px;
                gap: 4px;
            }

            .message-bubble {
                padding: 8px 10px;
                border-radius: 10px;
                font-size: 13px;
            }

            .message-bubble table,
            .message-bubble th,
            .message-bubble td {
                font-size: 12px;
                padding: 6px;
            }

            .message-bubble h3 {
                font-size: 0.9em;
                margin: 10px 0 6px 0;
            }

            .timestamp {
                font-size: 9px;
            }

            .avatar {
                width: 25px;
                height: 25px;
                margin: 0 4px;
            }

            .input-container {
                padding: 8px;
                gap: 4px;
            }

            .input-textarea {
                height: 36px;
                padding: 6px 10px;
                font-size: 13px;
            }

            .send-button, .mic-button, .mute-button {
                padding: 6px;
                width: 36px;
                height: 36px;
                font-size: 13px;
                border-radius: 8px;
            }

            .send-button {
                padding: 6px 12px;
                height: 36px;
            }

            .sheets-button {
                width: 36px;
                height: 36px;
                margin-left: 4px;
                border-radius: 8px;
            }

            .footer {
                padding: 6px;
                font-size: 11px;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
            }

            .header h1 {
                font-size: 20px;
            }

            .message-bubble {
                font-size: 16px;
            }

            .input-textarea {
                font-size: 16px;
            }
        }

        .sheets-button {
            background: #000;
            color: #fff;
            padding: 10px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: clamp(14px, 1.8vw, 16px);
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: -0.01em;
            touch-action: manipulation;
            width: 48px;
            height: 48px;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(74, 74, 74, 0.2);
        }

        .sheets-button:hover {
            background: #4A4A4A;
            box-shadow: 0 0 12px rgba(255, 107, 53, 0.9), 0 2px 6px rgba(255, 107, 53, 0.4);
        }

        .sheets-button.active {
            background: #ed5d05;
        }

        /* Add styles for document headers */
        .document-header {
            color: #ed5d05;
            font-weight: 600;
            margin: 20px 0 10px 0;
            font-size: 1.1em;
        }

        .mute-slash {
            /* Initially hidden, controlled by JS */
            display: none;
        }

        .sound-waves {
            /* Initially visible, controlled by JS */
            display: block;
        }

        .mute-button.muted .mute-slash {
            display: block;
        }

        .mute-button.muted .sound-waves {
            display: none;
        }

        .mute-button.glowing {
             animation: glow 0.8s infinite alternate ease-in-out;
        }

        .send-button.glowing {
             animation: glow 0.8s infinite alternate ease-in-out;
        }

        /* Styles for inline preview table */
        .table-wrapper-scroll {
            overflow-x: auto;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .preview-table-inline {
            width: auto; /* Allow table to be wider than its container */
            min-width: 100%; /* Ensure it takes at least 100% width if content is small */
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden; /* For rounded corners */
        }

        .preview-table-inline th,
        .preview-table-inline td {
            padding: 12px; /* Increased padding for better readability */
            border: 1px solid #ed5d05; /* Same border color */
            text-align: left;
            white-space: nowrap; /* Prevent text wrapping in headers */
            color: #000; /* Text color for content */
        }

        .preview-table-inline th {
            background: #ed5d0587; /* Header background */
            color: #000; /* Header text color */
            font-weight: 600;
            white-space: normal; /* Allow text wrapping in headers */
        }
        
        .preview-table-inline tr:nth-child(even) {
            background: rgba(235, 119, 37, 0.05); /* Alternating row background */
        }

        .preview-table-inline tr:hover {
            background: rgba(37, 99, 235, 0.1); /* Hover effect */
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="container">
        <!-- Header Component -->
        <div class="header">
            <img src="static/images/PGP-White-Logo-Transparent.png" alt="PG Glass Logo" class="logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/50x50?text=Logo+Error';">
            <h1>PGP-GPT</h1>
            <div class="toggle-container">
                <button class="sheets-button" id="sheets-button" onclick="toggleSheetsMode()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 9H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 21V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Area Component -->
        <div class="chat-container" id="chat-container">
            <!-- Messages will be appended here -->
            <div class="welcome-message-area">
                <!-- <img src="chat.png" alt="Bot Icon" class="bot-icon"> -->
                <p class="welcome-text">Welcome!</p>
                <p class="question-text">What can I help you with?</p>
            </div>
        </div>

        <!-- Input Bar Component -->
        <div class="input-container">
            <textarea class="input-textarea" id="user-input" placeholder="Type your message..."></textarea>
            <button class="send-button" id="send-button" onclick="enqueueMessage()">
                <svg id="send-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <svg id="stop-icon" style="display: none;" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="#e5e7eb" stroke-width="2"/>
                    <rect x="9" y="9" width="6" height="6" fill="#e5e7eb" rx="1.5" ry="1.5"/>
                </svg>
            </button>
            <button class="mic-button" id="mic-button" onclick="toggleSpeechRecognition()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 1C11.2044 1 10.4413 1.31607 9.87868 1.87868C9.31607 2.44129 9 3.20435 9 4V12C9 12.7956 9.31607 13.5587 9.87868 14.1213C10.4413 14.6839 11.2044 15 12 15C12.7956 15 13.5587 14.6839 14.1213 14.1213C14.6839 13.5587 15 12.7956 15 12V4C15 3.20435 14.6839 2.44129 14.1213 1.87868C13.5587 1.31607 12.7956 1 12 1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 10V12C19 13.8565 18.2625 15.637 16.9497 16.9497C15.637 18.2625 13.8565 19 12 19C10.1435 19 8.36301 18.2625 7.05025 16.9497C5.7375 15.637 5 13.8565 5 12V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 19V23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8 23H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="mute-button" id="mute-button" onclick="toggleMute()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Speaker cone - visible in both states -->
                    <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <!-- Sound waves - visible when UNMUTED -->
                    <path d="M15.54 8.46C16.4774 9.39764 17.004 10.6692 17.004 11.995C17.004 13.3208 16.4774 14.5924 15.54 15.53" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sound-waves"/>
                    <path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sound-waves"/>
                     <!-- Mute slash - visible when MUTED -->
                    <line x1="2" y1="2" x2="22" y2="22" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="mute-slash"/>
                </svg>
            </button>
        </div>

        <!-- Footer Component -->
        <div class="footer">
            Powered by <a href="https://darkslategray-weasel-292671.hostingersite.com/"><img src="static/images/ailifebot-logo.png" alt="Logo" style="width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 5px;">AI LifeBot</a>
        </div>
    </div>
    <script>
        // Initialize Web Speech API with better browser detection
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isWebSpeechSupported = false;

        try {
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'en-IN'; // Switch to 'hi-IN' for Hindi
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                isWebSpeechSupported = true;
            }
        } catch (e) {
            console.warn('Web Speech API not supported:', e);
            isWebSpeechSupported = false;
        }

        let isRecognizing = false;
        let lastInputWasSpeech = false;

        // Audio streaming setup
        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let sourceNode = null;
        let isMuted = JSON.parse(localStorage.getItem('isMuted')) || false;
        let isStreaming = false;
        let currentAudio = null;

        // MediaRecorder setup for server-side STT fallback
        let mediaRecorder = null;
        let audioChunks = [];

        // Check for MediaRecorder support
        const isMediaRecorderSupported = !!(navigator.mediaDevices && window.MediaRecorder);

        // Function to stream audio from the backend
        async function streamAudio(text, history) {
            if (isMuted) return;

            try {
                const response = await fetch("/stream_audio", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text,
                        history: history || []
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const data = await response.json();
                if (data.status === "success" && data.audio) {
                    playAudio(data.audio);
                } else {
                    throw new Error('Invalid audio data received from server');
                }
            } catch (error) {
                console.error('Audio streaming error:', error);
                throw error;
            }
        }

        // Initialize mute button state
        const muteButton = document.getElementById('mute-button');
        updateMuteButton();

        // Toggle mute state
        function toggleMute() {
            isMuted = !isMuted;
            localStorage.setItem('isMuted', JSON.stringify(isMuted));
            updateMuteButton();
            if (isMuted) {
                stopAudioStream();
            }
        }

        // Update mute button appearance
        function updateMuteButton() {
            muteButton.classList.toggle('muted', isMuted);
        }

        // Stop audio stream
        function stopAudioStream() {
            if (sourceNode) {
                sourceNode.stop();
                sourceNode.disconnect();
                sourceNode = null;
            }
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            isStreaming = false;
            if (audioContext.state === 'running') {
                audioContext.suspend();
            }
            const muteButton = document.getElementById('mute-button');
            muteButton.classList.remove('glowing');
        }

        // Play audio with interrupt capability
        function playAudio(audioData) {
            stopAudioStream(); // Interrupt any currently playing audio
            if (!isMuted) {
                const muteButton = document.getElementById('mute-button');
                muteButton.classList.add('glowing');
                
                // Create and play the audio from base64 data
                    currentAudio = new Audio(`data:audio/mp3;base64,${audioData}`);
                currentAudio.play().catch(e => {
                    console.error('Audio playback error:', e);
                    displayError('Audio playback failed: ' + e.message);
                });
                
                currentAudio.onended = () => {
                    currentAudio = null;
                    muteButton.classList.remove('glowing');
                };
            }
        }

        // Define HEADERS for the Excel sheet, mirroring backend
        const headers = [
            "Sr. No.",
            "Description of the Contract",
            "Name of the first Party",
            "Name of the second Party",
            "Date of Request",
            "Purpose",
            "Agreement Commencement date",
            "Duration of the Agreement",
            "Department Responsibility",
            "Internal Status",
            "Signed Copy RECEIVED on IVALUA (Y/N)",
            "Uploaded on IVALUA"
        ];

        // Load and sanitize chat history from local storage
        let chatHistory = [];
        
        // Check if this is a fresh server load by checking a server timestamp
        fetch("/server_timestamp")
            .then(response => response.json())
            .then(data => {
                const lastServerTimestamp = localStorage.getItem('lastServerTimestamp');
                if (lastServerTimestamp !== data.timestamp) {
                    // Server has been reloaded, clear history
                    localStorage.removeItem('chatHistory');
                    localStorage.setItem('lastServerTimestamp', data.timestamp);
                } else {
                    // Server hasn't been reloaded, load existing history
                    chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        chatHistory = chatHistory.filter(msg => {
            if (!msg.role || !msg.text) return false;
            return true;
        }).map(msg => {
            return {
                role: msg.role || 'user',
                text: msg.text,
                timestamp: msg.timestamp || new Date().toISOString(),
                isSpeech: msg.isSpeech || false
            };
        });
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                }
                // Render initial chat history
                chatHistory.forEach(renderMessage);
            })
            .catch(error => {
                console.error('Error checking server timestamp:', error);
                // If there's an error, load existing history
                chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
                chatHistory = chatHistory.filter(msg => {
                    if (!msg.role || !msg.text) return false;
                    return true;
                }).map(msg => {
                    return {
                        role: msg.role || 'user',
                        text: msg.text,
                        timestamp: msg.timestamp || new Date().toISOString(),
                        isSpeech: msg.isSpeech || false
                    };
                });
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                // Render initial chat history
                chatHistory.forEach(renderMessage);
            });

        const chatContainer = document.getElementById('chat-container');

        // Query queue to manage sequential processing
        let queryQueue = [];
        let isProcessingQueue = false;
        let isTyping = false; // Track typing state
        let typingTimeout = null; // Store typing timeout

        // Auto-scroll to bottom
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Configure marked options
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false,
            sanitize: false,
            smartLists: true,
            smartypants: true,
            xhtml: false
        });

        // Render a message without typing animation (for user messages and history)
        function renderMessage(message) {
            const div = document.createElement('div');
            div.className = `message ${message.role === 'assistant' ? 'bot' : message.role}-message`;
            
            div.innerHTML = `
                ${message.role === 'assistant' ? '<img src="https://ui-avatars.com/api/?name=Bot&background=5A5A5A&color=e5e7eb&size=40" class="avatar bot-avatar" alt="Bot Avatar">' : ''}
                <div class="message-bubble">
                    <span class="message-text"></span>
                    <div class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</div>
                </div>
                ${message.role === 'user' ? '<img src="https://ui-avatars.com/api/?name=User&background=FF6200&color=fff&size=40" class="avatar" alt="User Avatar">' : ''}
            `;
            chatContainer.appendChild(div);
            scrollToBottom();

            const messageTextElement = div.querySelector('.message-text');

            // Render content based on type and presence of SharePoint link
            if (message.role === 'assistant') {
                if (message.text.includes('View in SharePoint')) {
                    messageTextElement.innerHTML = message.text; // Directly set HTML for the link
                } else {
                    messageTextElement.innerHTML = marked.parse(message.text); // Parse as Markdown
                }
            } else { // User message
                messageTextElement.textContent = message.text; // User messages are plain text
            }
            
            // Typeset LaTeX in the new message
            MathJax.typesetPromise([div]).catch((err) => console.error('MathJax typesetting failed:', err));
        }

        // Render a message with typing animation and optional simultaneous audio
        async function typeMessage(message, audioText, sanitizedHistory, callback) {
            const div = document.createElement('div');
            div.className = `message bot-message`;
            div.innerHTML = `
                <img src="https://ui-avatars.com/api/?name=Bot&background=5A5A5A&color=e5e7eb&size=40" class="avatar bot-avatar" alt="Bot Avatar">
                <div class="message-bubble">
                    <span class="message-text"></span>
                    <div class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</div>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();

            const messageTextElement = div.querySelector('.message-text');
            const text = message.text;
            let index = 0;
            let isTyping = true; // Use 'let' for reassignability

            // Show loading animation if this is a voice response
            if (lastInputWasSpeech && !isMuted) {
                const loader = displayLoader();
                try {
                    await streamAudio(audioText, sanitizedHistory);
                    removeElement(loader);
                } catch (error) {
                    removeElement(loader);
                    displayError('Error generating voice response: ' + error.message);
                }
            }

            // If the message contains the SharePoint link, render it directly as HTML and skip typing animation
            if (text.includes('View in SharePoint')) {
                messageTextElement.innerHTML = text; // Directly set innerHTML for the link
                MathJax.typesetPromise([div]).catch((err) => console.error('MathJax typesetting failed:', err));
                isTyping = false; // Disable typing animation for this message
                if (callback) callback();
                return; // Exit the function early
            }

            function type() {
                if (!isTyping) {
                    // Ensure full content is rendered even if typing is interrupted
                    messageTextElement.innerHTML = marked.parse(text); 
                    MathJax.typesetPromise([div]).catch((err) => console.error('MathJax typesetting failed:', err));
                    if (callback) callback();
                    return;
                }

                if (index < text.length) {
                    // Standard typing animation for non-SharePoint link messages
                    messageTextElement.textContent += text.charAt(index);
                    index++;
                    scrollToBottom();
                    typingTimeout = setTimeout(type, 0.5);
                } else {
                    isTyping = false;
                    clearTimeout(typingTimeout);
                    // Parse the full message text after typing is complete for non-SharePoint link messages
                    messageTextElement.innerHTML = marked.parse(message.text);
                    MathJax.typesetPromise([div]).catch((err) => console.error('MathJax typesetting failed:', err));
                    if (callback) callback();
                }
            }

            type();
        }

        function displayError(message) {
            console.error(message);
            const div = document.createElement('div');
            div.className = 'error-message';
            
            // Add browser-specific guidance
            let browserMessage = message;
            if (message.includes('network') || message.includes('not supported')) {
                browserMessage += '\n\nBrowser Compatibility:\n' +
                    '• Chrome: Full support\n' +
                    '• Edge: Full support\n' +
                    '• Firefox: Partial support\n' +
                    '• Safari: Limited support\n' +
                    '• Arc: Limited support\n\n' +
                    'For best experience, please use Chrome or Edge.';
            }
            
            div.textContent = browserMessage;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // Display loader
        function displayLoader() {
            const div = document.createElement('div');
            div.className = 'loader';
            div.id = `loader-${Date.now()}`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return div;
        }

        // Display typing indicator
        function displayTypingIndicator() {
            const div = document.createElement('div');
            div.className = 'typing-indicator';
            div.id = `typing-indicator-${Date.now()}`;
            div.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(div);
            scrollToBottom();
            return div;
        }

        // Remove loader or typing indicator
        function removeElement(element) {
            if (element && element.parentNode) {
                element.parentNode.removeChild(element);
            }
        }

        let sheetsModeEnabled = false;

        // Variable to hold the current preview message element
        let currentPreviewMessageElement = null;

        function toggleSheetsMode() {
            sheetsModeEnabled = !sheetsModeEnabled;
            const sheetsButton = document.getElementById('sheets-button');
            const inputTextarea = document.getElementById('user-input');
            
            sheetsButton.classList.toggle('active', sheetsModeEnabled);
            inputTextarea.placeholder = sheetsModeEnabled ? 
                "Enter contract details in natural language..." : 
                "Type your message...";
            
            // Hide/remove the preview table when switching modes
            if (currentPreviewMessageElement) {
                removeElement(currentPreviewMessageElement);
                currentPreviewMessageElement = null;
            }
        }

        // Modify the enqueueMessage function to handle sheets mode
        async function enqueueMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const sendButton = document.getElementById('send-button');
            const sendIcon = document.getElementById('send-icon');
            const stopIcon = document.getElementById('stop-icon');

            if (isProcessingQueue || isTyping) {
                // Interrupt current processing and typing
                isProcessingQueue = false;
                isTyping = false;
                clearTimeout(typingTimeout);
                queryQueue = [];
                // Do not stop audio stream here, it's handled by playAudio
                const loader = document.querySelector('.loader');
                const typingIndicator = document.querySelector('.typing-indicator');
                removeElement(loader);
                removeElement(typingIndicator);
                sendButton.classList.remove('processing');
                sendIcon.style.display = 'block';
                stopIcon.style.display = 'none';
                
                // Hide/remove the preview table if interrupting
                if (currentPreviewMessageElement) {
                    removeElement(currentPreviewMessageElement);
                    currentPreviewMessageElement = null;
                }
                return;
            }

            if (!text) return;

            if (sheetsModeEnabled) {
                // Handle sheets mode
                try {
                    sendButton.classList.add('processing');
                    sendIcon.style.display = 'none';
                    stopIcon.style.display = 'block';

                    // Hide any previously displayed preview table if still present
                    if (currentPreviewMessageElement) {
                        removeElement(currentPreviewMessageElement);
                        currentPreviewMessageElement = null;
                    }

                    // Show loading state
                    const loader = displayLoader();

                    const response = await fetch("https://pgp-excel-agent.politegrass-0dd17cd2.centralindia.azurecontainerapps.io/api/preview", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ input: text })
                    });

                    // Remove loader
                    removeElement(loader);

                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        // Create a new message div for the preview table
                        const previewMessageDiv = document.createElement('div');
                        previewMessageDiv.className = `message bot-message`;
                        previewMessageDiv.innerHTML = `
                            <img src="https://ui-avatars.com/api/?name=Bot&background=5A5A5A&color=e5e7eb&size=40" class="avatar bot-avatar" alt="Bot Avatar">
                            <div class="message-bubble">
                                <h3>Preview Parsed Data</h3>
                                <div class="table-wrapper-scroll">
                                    <table class="preview-table-inline">
                                        <thead>
                                            <tr class="preview-table-headers-inline"></tr>
                                        </thead>
                                        <tbody class="preview-table-body-inline"></tbody>
                                    </table>
                                </div>
                                <div class="duplicate-info-inline mt-4"></div>
                                <button class="send-button submit-preview-btn-inline" style="margin-top: 10px;">
                                    Submit to Excel
                                </button>
                            </div>
                        `;
                        chatContainer.appendChild(previewMessageDiv);
                        scrollToBottom();

                        currentPreviewMessageElement = previewMessageDiv; // Store reference

                        const previewTableHeadersRow = previewMessageDiv.querySelector('.preview-table-headers-inline');
                        const previewTableBody = previewMessageDiv.querySelector('.preview-table-body-inline');
                        const duplicateInfo = previewMessageDiv.querySelector('.duplicate-info-inline');
                        const submitButton = previewMessageDiv.querySelector('.submit-preview-btn-inline');

                        // Populate table headers and values
                        const valuesRow = previewTableBody.insertRow(); // Only one row for values

                        for (const header of headers) {
                            const th = document.createElement('th');
                            th.textContent = header.replace(/\(Y\/N\)/, '').replace(/_OF_THE/, '').replace(/_/, ' ').replace(/  /g, ' ').trim(); // Clean header for display
                            previewTableHeadersRow.appendChild(th);

                            const td = valuesRow.insertCell();
                            td.textContent = data.preview[header] || '';
                        }

                        // Populate duplicate info
                        let overwriteNeeded = false;
                        if (data.duplicate_info.full_duplicate) {
                            duplicateInfo.innerHTML = `<p style="color: #ef4444;">Warning: Exact duplicate found at row ${data.duplicate_info.row}</p>`;
                        } else if (data.duplicate_info.sr_no_duplicate) {
                            duplicateInfo.innerHTML = `<p style="color: #f59e0b;">Warning: Duplicate Sr. No. found at row ${data.duplicate_info.row}</p>`;
                            overwriteNeeded = true;
                        } else {
                            duplicateInfo.innerHTML = '';
                        }

                        // Add submit button handler
                        submitButton.onclick = async () => {
                            try {
                                submitButton.disabled = true;
                                submitButton.textContent = 'Submitting...';
                                
                                const submitResponse = await fetch("https://pgp-excel-agent.politegrass-0dd17cd2.centralindia.azurecontainerapps.io/api/submit", {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ 
                                        input: text,
                                        overwrite: overwriteNeeded // Use the detected overwriteNeeded flag
                                    })
                                });

                                const submitData = await submitResponse.json();
                                
                                if (submitData.success) {
                                    let messageText = `✅ ${submitData.message}`; 
                                    if (submitData.web_url) {
                                        messageText += ` <a href="${submitData.web_url}" target="_blank" style="color: #ed5d05; text-decoration: underline;">View Changes on SharePoint</a>`;
                                    }
                                    // Add success message to chat
                                    const successMessage = {
                                        role: 'assistant',
                                        text: messageText,
                                        timestamp: new Date().toISOString()
                                    };
                                    chatHistory.push(successMessage);
                                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                                    renderMessage(successMessage);
                                    
                                    // Remove the preview table from the chat after submission
                                    if (currentPreviewMessageElement) {
                                        removeElement(currentPreviewMessageElement);
                                        currentPreviewMessageElement = null;
                                    }
                                } else {
                                    throw new Error(submitData.error || 'Failed to submit data');
                                }
                            } catch (error) {
                                displayError(`Error submitting data: ${error.message}`);
                            } finally {
                                submitButton.disabled = false;
                                submitButton.textContent = 'Submit to Excel';
                            }
                        };
                    } else {
                        throw new Error(data.error || 'Failed to preview data');
                    }
                } catch (error) {
                    console.error('Sheets error:', error);
                    displayError(`Error previewing data: ${error.message}`);
                } finally {
                    sendButton.classList.remove('processing');
                    sendIcon.style.display = 'block';
                    stopIcon.style.display = 'none';
                }
            } else {
                // Hide/remove the preview table if not in sheets mode
                if (currentPreviewMessageElement) {
                    removeElement(currentPreviewMessageElement);
                    currentPreviewMessageElement = null;
                }

                // Handle normal chat mode
                queryQueue.push({ text, isSpeech: lastInputWasSpeech });
                if (!lastInputWasSpeech) {
                    lastInputWasSpeech = false;
                }
                processNextQuery();
            }

            input.value = ''; // Clear input immediately
        }

        // Function to process the next query in the queue
        async function processNextQuery() {
            if (isProcessingQueue || queryQueue.length === 0) return;
            
            const sendButton = document.getElementById('send-button');
            const sendIcon = document.getElementById('send-icon');
            const stopIcon = document.getElementById('stop-icon');

            isProcessingQueue = true;
            sendButton.classList.add('processing');
            sendIcon.style.display = 'none';
            stopIcon.style.display = 'block';

            // Add glowing class when processing starts
            sendButton.classList.add('glowing');

            const { text, isSpeech } = queryQueue.shift();
            
            // Add user message to history and display immediately
            const userMessage = { 
                role: 'user', 
                text, 
                timestamp: new Date().toISOString(), 
                isSpeech 
            };
            chatHistory.push(userMessage);
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderMessage(userMessage);

            // Remove the welcome message after the first user message
            if (chatHistory.length === 1 && !sheetsModeEnabled) { // Check if it's the very first message and not in sheets mode
                const welcomeArea = document.querySelector('.welcome-message-area');
                if (welcomeArea) {
                    welcomeArea.remove();
                }
            }

            // Show loader to reserve space
            const loader = displayLoader();

            try {
                // Sanitize history for sending
                const sanitizedHistory = chatHistory.slice(-5).map(msg => ({
                    role: msg.role,
                    text: msg.text,
                    timestamp: msg.timestamp || new Date().toISOString(),
                    isSpeech: msg.isSpeech || false
                }));

                // Call backend chat endpoint
                const response = await fetch("/chat", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text, 
                        history: sanitizedHistory,
                        is_speech: isSpeech // Use the isSpeech from the queue item
                    })
                });

                // Remove loader
                removeElement(loader);

                // Show typing indicator
                const typingIndicator = displayTypingIndicator();

                // Simulate thinking delay (1 second)
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Remove typing indicator
                removeElement(typingIndicator);

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                // Handle single response with typing animation and optional audio
                const botMessage = { 
                    role: 'assistant', 
                    text: data.responses[0],
                    timestamp: new Date().toISOString(),
                    isSpeech: isSpeech // Use the isSpeech from the queue item
                };
                chatHistory.push(botMessage);
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                
                // Use typeMessage for streaming effect and optional simultaneous audio
                await typeMessage(botMessage, data.responses[0], sanitizedHistory, () => {
                    isProcessingQueue = false;
                    sendButton.classList.remove('processing');
                    sendIcon.style.display = 'block';
                    stopIcon.style.display = 'none';
                    // Remove glowing class when typing is complete
                    sendButton.classList.remove('glowing');
                    processNextQuery(); // Process next query in queue
                });
            } catch (error) {
                console.error('Fetch error details:', error);
                removeElement(loader);
                removeElement(document.querySelector('.typing-indicator'));
                displayError(`Error: ${error.message}. Ensure the backend is running on http://localhost:8001.`);
                isProcessingQueue = false;
                sendButton.classList.remove('processing');
                sendIcon.style.display = 'block';
                stopIcon.style.display = 'none';
                // Remove glowing class on error
                sendButton.classList.remove('glowing');
                processNextQuery(); // Process next query in queue
            }
        }

        // Update toggleSpeechRecognition function
        async function toggleSpeechRecognition() {
            const micButton = document.getElementById('mic-button');
            
            if (isRecognizing) {
                if (isWebSpeechSupported && recognition) {
                    recognition.stop();
                } else if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                return;
            }

            // Stop any playing audio
            if (isStreaming || currentAudio) {
                stopAudioStream();
            }

            try {
                if (isWebSpeechSupported && recognition) {
                    // Use Web Speech API
                    recognition.onstart = () => {
                        isRecognizing = true;
                        micButton.classList.add('recording');
                    };

                    recognition.onend = () => {
                        isRecognizing = false;
                        micButton.classList.remove('recording');
                    };

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('user-input').value = transcript;
                        lastInputWasSpeech = true;
                        enqueueMessage();
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        if (event.error === 'network') {
                            // Fallback to server-side transcription
                            startServerSideTranscription();
                        } else {
                            displayError(`Speech recognition error: ${event.error}`);
                        }
                        isRecognizing = false;
                        micButton.classList.remove('recording');
                    };

                    recognition.start();
                } else {
                    // Fallback to server-side transcription
                    startServerSideTranscription();
                }
            } catch (error) {
                console.error('Speech recognition error:', error);
                // Fallback to server-side transcription
                startServerSideTranscription();
            }
        }

        // Server-side transcription fallback
        async function startServerSideTranscription() {
            const micButton = document.getElementById('mic-button');
            
            if (!isMediaRecorderSupported) {
                displayError('Audio recording not supported in this browser. Please use Chrome or Edge.');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'recording.wav');

                    try {
                        const response = await fetch('/transcribe', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error ${response.status}`);
                        }

                        const data = await response.json();
                        if (data.text) {
                            document.getElementById('user-input').value = data.text;
                            lastInputWasSpeech = true;
                            enqueueMessage();
                        } else {
                            displayError('No speech detected. Please try again.');
                        }
                    } catch (error) {
                        displayError('Speech transcription error: ' + error.message);
                    } finally {
                        isRecognizing = false;
                        micButton.classList.remove('recording');
                        stream.getTracks().forEach(track => track.stop());
                    }
                };

                isRecognizing = true;
                micButton.classList.add('recording');
                mediaRecorder.start();
            } catch (error) {
                displayError('Failed to start audio recording: ' + error.message);
                isRecognizing = false;
                micButton.classList.remove('recording');
            }
        }

        // Handle Enter key to send message
        document.getElementById('user-input').addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                lastInputWasSpeech = false; // Set to false when input is typed
                enqueueMessage();
            }
        });

        // Initial scroll to bottom
        scrollToBottom();

        async function syncSharePoint(action) {
            try {
                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                const data = await response.json();

                if (!data.success) {
                    showMessage(data.error, 'error');
                    return;
                }

                let message = '';
                if (data.results.download) {
                    message += `Download: ${data.results.download.message} `;
                }
                if (data.results.upload) {
                    message += `Upload: ${data.results.upload.message}`;
                }
                
                if (data.web_url) {
                    message += ` <a href="${data.web_url}" target="_blank" style="color: #ed5d05; text-decoration: underline;">View in SharePoint</a>`;
                }
                showMessage(message.trim(), 'success');
            } catch (error) {
                showMessage(`Sync failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.getElementById('previewBtn').addEventListener('click', previewData);
        document.getElementById('submitBtn').addEventListener('click', submitData);
        document.getElementById('syncDownloadBtn').addEventListener('click', () => syncSharePoint('download'));
        document.getElementById('syncUploadBtn').addEventListener('click', () => syncSharePoint('upload'));
        document.getElementById('syncBothBtn').addEventListener('click', () => syncSharePoint('both'));
        document.getElementById('sheetsModeCheckbox').addEventListener('change', (e) => toggleSheetsMode(e.target.checked));

        // Check initial sheets mode
        async function checkSheetsMode() {
            sheetsModeEnabled = document.getElementById('sheetsModeCheckbox').checked;
            toggleSheetsMode();
        }
    </script>
</body>
</html>